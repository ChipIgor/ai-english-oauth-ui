<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AI English – Connect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:560px;margin:40px auto;padding:0 16px}
    input,button{font-size:16px;padding:10px 12px;width:100%;margin:8px 0}
    button{cursor:pointer}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .muted{color:#666;font-size:13px}
    .err{color:#b00020;white-space:pre-wrap}
    .ok{color:#0b6;white-space:pre-wrap}
    code{background:#f5f5f5;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <h2>Connect AI English</h2>
  <p class="muted">Login via email code, then we’ll send you back to ChatGPT.</p>

  <div id="err" class="err"></div>
  <div id="ok" class="ok"></div>

  <label>Email</label>
  <input id="email" placeholder="you@example.com" type="email" autocomplete="email" />

  <button id="send">Send code</button>

  <label>Code</label>
  <input id="otp" placeholder="123456" inputmode="numeric" />

  <div class="row">
    <button id="verify">Verify & Connect</button>
  </div>

  <p class="muted">Project: <code id="sb_url"></code></p>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const params = new URLSearchParams(location.search);
  const SB_URL = params.get("sb_url");
  const SB_ANON_KEY = params.get("sb_anon");
  const client_id = params.get("client_id");
  const redirect_uri = params.get("redirect_uri");
  const state = params.get("state");
  const issue_code_url = SB_URL ? SB_URL.replace(/\/+$/, "") + "/functions/v1/oauth/issue_code" : null;

  document.getElementById("sb_url").textContent = SB_URL || "";

  if (!SB_URL || !SB_ANON_KEY || !client_id || !redirect_uri || !state || !issue_code_url) {
    document.getElementById("err").textContent = "Missing parameters";
    throw new Error("Missing parameters");
  }

  const supabase = createClient(SB_URL, SB_ANON_KEY);

  const $ = (id) => document.getElementById(id);
  const showErr = (m) => { $("err").textContent = m || ""; };
  const showOk  = (m) => { $("ok").textContent = m || ""; };

  $("send").onclick = async () => {
    try {
      showErr(""); showOk("");
      const email = $("email").value.trim();
      if (!email) throw new Error("Enter email");
      const { error } = await supabase.auth.signInWithOtp({ email });
      if (error) throw error;
      showOk("Code sent. Check your email.");
    } catch (e) {
      showErr(String(e?.message ?? e));
    }
  };

  $("verify").onclick = async () => {
    try {
      showErr(""); showOk("");
      const email = $("email").value.trim();
      const token = $("otp").value.trim();
      if (!email) throw new Error("Enter email");
      if (!token) throw new Error("Enter code");

      const { data, error } = await supabase.auth.verifyOtp({ email, token, type: "email" });
      if (error) throw error;
      const access_token = data?.session?.access_token;
      const refresh_token = data?.session?.refresh_token;
      const expires_at = data?.session?.expires_at;

      if (!access_token) throw new Error("No session token after verify");

      const resp = await fetch(issue_code_url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + access_token,
        },
        body: JSON.stringify({
          client_id,
          redirect_uri,
          state,
          access_token,
          refresh_token,
          expires_at,
        }),
      });

      const out = await resp.json();
      if (!resp.ok || !out?.ok) throw new Error(out?.error?.message || "issue_code failed");

      const code = out.data.code;
      const redirect = new URL(redirect_uri);
      redirect.searchParams.set("code", code);
      redirect.searchParams.set("state", state);

      location.href = redirect.toString();
    } catch (e) {
      showErr(String(e?.message ?? e));
    }
  };
</script>
</body>
</html>
